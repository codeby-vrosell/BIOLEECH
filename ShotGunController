using UnityEngine;
using Unity.Cinemachine;
using System.Linq;
using System.Collections;
using UnityEngine.VFX;

public class ShotGunController : MonoBehaviour {

    // ============================================================
    // References
    // ============================================================

    private FPControllerGun fpControllerGunScript;
    private UpgradesController upgradesControllerScript;
    private CrosshairController crosshairControllerScript;
    private RecoilWeapon recoilWeaponScript;
    public CinemachineImpulseSource impulseSource;
    private TPController tpControllerScript;

    // ============================================================
    // Weapon Settings
    // ============================================================

    public int bullets;
    public float cadence;
    public bool canShoot = true;
    public float spreadAngle;

    private int ignoreLayers;

    // ============================================================
    // Shooting Point
    // ============================================================

    public Transform firePoint;

    // ============================================================
    // Visual Effects
    // ============================================================

    public VisualEffect vfxTrail;
    public GameObject vfxImpact;

    // ============================================================
    // Sounds
    // ============================================================

    [Header("Sounds")]
    public AudioClip shootSound;

    // ============================================================
    // Unity Methods
    // ============================================================

    void start() {

        GameObject playerObj = GameObject.FindWithTag("Player");

        upgradesControllerScript = playerObj.GetComponent<UpgradesController>();
        fpControllerGunScript = Object.FindFirstObjectByType<FPControllerGun>();
        crosshairControllerScript = Object.FindFirstObjectByType<CrosshairController>();
        recoilWeaponScript = Object.FindFirstObjectByType<RecoilWeapon>();
        tpControllerScript = Object.FindFirstObjectByType<TPController>();

        ignoreLayers = ~(LayerMask.GetMask("Player", "Weapon", "EnemySpawn", "EnemyMark", "ignoreGun"));

    }

    void update() {

        crosshairControllerScript.checkTarget();

        if (fpControllerGunScript.attackButtonPressed && !fpControllerGunScript.isInQTE && !fpControllerGunScript.isCleaning && (tpControllerScript == null || !tpControllerScript.isTeleporting)) {

            if (canShoot) {

                fpControllerGunScript.isShooting = true;
                recoilWeaponScript.aiming = true;
                StartCoroutine(shootRaycast());

            }
        }

        else {

            fpControllerGunScript.isShooting = false;
            recoilWeaponScript.aiming = false;

        }
    }

    // ============================================================
    // Shooting Logic
    // ============================================================

    IEnumerator shootRaycast() {

        if (bullets > 0) {

            canShoot = false;

            // Play shooting sound and trigger trail effect
            AudioManager.instance.PlaySoundFXClip(shootSound, transform, 0.7f);
            vfxTrail.SetBool("Started", true);
            vfxTrail.Play();

            // Calculate bullet spread
            Vector3 shootDirection = firePoint.forward;
            Quaternion spreadRotation = Quaternion.Euler(Random.Range(-spreadAngle, spreadAngle), Random.Range(-spreadAngle, spreadAngle), 0);
            Vector3 finalDirection = spreadRotation * shootDirection;

            // Raycast to detect hit
            if (Physics.Raycast(firePoint.position, finalDirection, out RaycastHit hit, upgradesControllerScript.gunRange, ignoreLayers)) {

                GameObject vfxPrefab = Instantiate(vfxImpact, hit.point, Quaternion.LookRotation(hit.normal));
                vfxImpact.GetComponent<VisualEffect>().SetVector3("Orientation", vfxImpact.transform.eulerAngles);

                if (hit.collider.gameObject.layer == LayerMask.NameToLayer("Enemy") || hit.collider.gameObject.layer == LayerMask.NameToLayer("EnemyDetected")) {

                    EnemyHealth2 enemyHealth2Script = hit.collider.gameObject.GetComponent<EnemyHealth2>();

                    if (enemyHealth2Script != null) {

                        enemyHealth2Script.takeDMG(upgradesControllerScript.dmgUpdate);

                    }
                }

                Destroy(vfxPrefab, 2f);

            }

            bullets = bullets - 1;

            // Recoil and camera impulse
            recoilWeaponScript.fire();
            impulseSource.GenerateImpulse();

            GamepadVibratorController.instance.startVibracion(0.6f, 0.1f);

            yield return new WaitForSeconds(cadence);

            canShoot = true;

        }

        else {

            fpControllerGunScript.isShooting = false;

        }
    }
}
